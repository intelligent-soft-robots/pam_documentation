<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Developer’s guide 4: Advanced overview &mdash; PAM Documentation 1.0.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Developer’s guide: Updating the documentation" href="E5_documentation.html" />
    <link rel="prev" title="Developer’s guide 3: Packages overview" href="E3_packages_overview.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> PAM Documentation
          </a>
              <div class="version">
                1.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="A1_overview_and_installation.html">Overview and software installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="B1_tutorial0.html">Tutorial 0: How to run tutorial demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="B2_tutorial1.html">Tutorial 1: Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="B3_tutorial2.html">Tutorial 2: Reading robot data</a></li>
<li class="toctree-l1"><a class="reference internal" href="B4_tutorial3.html">Tutorial 3: Iteration commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="B5_tutorial4.html">Tutorial 4: Joint control, table, balls, etc.</a></li>
<li class="toctree-l1"><a class="reference internal" href="B6_tutorial5.html">Tutorial 5: Saving data to files</a></li>
<li class="toctree-l1"><a class="reference internal" href="B7_tutorial6.html">Tutorial 6: Bursting mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="C1_handle.html">More info: MuJoCo handles and contacts</a></li>
<li class="toctree-l1"><a class="reference internal" href="C2_real_robot.html">More info: Using the real robot</a></li>
<li class="toctree-l1"><a class="reference internal" href="C3_executables.html">More info: List of executables</a></li>
<li class="toctree-l1"><a class="reference internal" href="C4_mirroring.html">More info: Mirroring real robot</a></li>
<li class="toctree-l1"><a class="reference internal" href="C5_visual_ball_tracking.html">More info: Visual ball tracking</a></li>
<li class="toctree-l1"><a class="reference internal" href="C6_saving_ball_and_racket_contacts.html">More info: Saving ball trajectories</a></li>
<li class="toctree-l1"><a class="reference internal" href="C7_ball_launcher.html">More info: Ball launcher</a></li>
<li class="toctree-l1"><a class="reference internal" href="E1_tools.html">Developer’s guide 1: Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="E2_guidelines.html">Developer’s guide 2: Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="E3_packages_overview.html">Developer’s guide 3: Packages overview</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developer’s guide 4: Advanced overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#mujoco-model-xml-file">MuJoCo model XML file</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mujoco-controller">MuJoCo controller</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mirrorrobot-poor-naming-it-just-means-position-and-velocity-control-of-the-robot">MirrorRobot (poor naming, it just means “position and velocity control of the robot”)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pressurecontroller">PressureController</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#relation-between-the-model-xml-file-and-the-controllers">Relation between the model xml file and the controllers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#relation-between-o80-and-controllers">Relation between o80 and controllers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#putting-things-together">Putting things together</a></li>
<li class="toctree-l2"><a class="reference internal" href="#c-and-python">C++ and Python</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="E5_documentation.html">Developer’s guide: Updating the documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">PAM Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Developer’s guide 4: Advanced overview</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/E4_advanced_overview.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="developer-s-guide-4-advanced-overview">
<h1>Developer’s guide 4: Advanced overview<a class="headerlink" href="#developer-s-guide-4-advanced-overview" title="Permalink to this headline"></a></h1>
<p>This page is a good read for anybody who would like to have a better understanding on how the software works “under the hood”.</p>
<section id="mujoco-model-xml-file">
<h2>MuJoCo model XML file<a class="headerlink" href="#mujoco-model-xml-file" title="Permalink to this headline"></a></h2>
<p>For Mujoco to work,  model xml file that describes the robot and environment is needed.
Possibly, this xml file can be created “by hand”.
In the case of pam_mujoco, things are a bit more involved because the API let the user customize the environment, e.g. add more balls, add a target, add muscles, etc. (see <a class="reference internal" href="C1_handle.html"><span class="doc std std-doc">handle</span></a>). For achieving this, the xml file is created “on the fly” by python in order to match the user configuration. The code for doing this is here:</p>
<ul class="simple">
<li><p>https://github.com/intelligent-soft-robots/pam_mujoco/blob/master/python/pam_mujoco/models.py</p></li>
</ul>
<p>If an example of an xml file is needed, one may run for example:</p>
<p>https://github.com/intelligent-soft-robots/pam_demos/blob/main/tutorial_4_backend.py#L57</p>
<p>which will generate one in a folder of /tmp/</p>
</section>
<section id="mujoco-controller">
<h2>MuJoCo controller<a class="headerlink" href="#mujoco-controller" title="Permalink to this headline"></a></h2>
<p>A controller is a piece of software that is called at each iteration of mujoco, and can modify mujoco’s global variables.
Mujoco has a global variable “mjcb_control” which is a pointer to a controller function. The user can set this pointer to the function of its choice, and this function will be called at each iteration.
The signature of the function must be :</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">function_name</span><span class="p">(</span><span class="k">const</span> <span class="n">mjModel</span><span class="o">*</span> <span class="n">m</span><span class="p">,</span> <span class="k">const</span> <span class="n">mjData</span><span class="o">*</span> <span class="n">d</span><span class="p">)</span><span class="s">&quot;. </span>
</pre></div>
</div>
<p>The function takes effect by overwriting some values in m and d.</p>
<p>In the pam mujoco code, we do this at this line:</p>
<ul class="simple">
<li><p>https://github.com/intelligent-soft-robots/pam_mujoco/blob/master/src/run_mujoco.cpp#L174</p></li>
</ul>
<p>The function give can be simple, but in our case it is bit complex. The function we pass is not a controller, but a series of controllers that will be called in succession (e.g. one for controlling ball1, another for controlling the pressures, etc).
The user can add controllers by calling the functions here (functions add_xxx):</p>
<ul class="simple">
<li><p>https://github.com/intelligent-soft-robots/pam_mujoco/blob/master/include/pam_mujoco/run_mujoco.hpp</p></li>
</ul>
<p>These functions add controllers to this vector:</p>
<ul class="simple">
<li><p>https://github.com/intelligent-soft-robots/pam_mujoco/blob/master/include/pam_mujoco/controllers.hpp#L50</p></li>
</ul>
<p>and the “apply” function (that will be called at each iteration) simply call each controller one by one:</p>
<ul class="simple">
<li><p>https://github.com/intelligent-soft-robots/pam_mujoco/blob/master/src/controllers.cpp#L52</p></li>
</ul>
<p>The controllers for the robots are :</p>
<section id="mirrorrobot-poor-naming-it-just-means-position-and-velocity-control-of-the-robot">
<h3>MirrorRobot (poor naming, it just means “position and velocity control of the robot”)<a class="headerlink" href="#mirrorrobot-poor-naming-it-just-means-position-and-velocity-control-of-the-robot" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>https://github.com/intelligent-soft-robots/pam_mujoco/blob/master/include/pam_mujoco/mirror_robot.hpp</p></li>
<li><p>https://github.com/intelligent-soft-robots/pam_mujoco/blob/master/include/pam_mujoco/mirror_robot.hxx</p></li>
</ul>
</section>
<section id="pressurecontroller">
<h3>PressureController<a class="headerlink" href="#pressurecontroller" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>https://github.com/intelligent-soft-robots/pam_mujoco/blob/master/include/pam_mujoco/pressure_controller.hpp</p></li>
<li><p>https://github.com/intelligent-soft-robots/pam_mujoco/blob/master/include/pam_mujoco/pressure_controller.hxx</p></li>
</ul>
</section>
</section>
<section id="relation-between-the-model-xml-file-and-the-controllers">
<h2>Relation between the model xml file and the controllers<a class="headerlink" href="#relation-between-the-model-xml-file-and-the-controllers" title="Permalink to this headline"></a></h2>
<p>To “items” in the xml files correspond indexes in the mjModel* that is passed to the controller function.
Let’s take MirrorRobot as example.
This controller takes in its constructor a string “robot_joint_base”:</p>
<ul class="simple">
<li><p>https://github.com/intelligent-soft-robots/pam_mujoco/blob/master/include/pam_mujoco/mirror_robot.hxx#L6</p></li>
</ul>
<p>This string correspond to the name of the first joint in the xml model file.
We use mujoco functions to get corresponding indexes:</p>
<ul class="simple">
<li><p>https://github.com/intelligent-soft-robots/pam_mujoco/blob/master/include/pam_mujoco/mirror_robot.hxx#L43</p></li>
</ul>
<p>These indexes allows us to overwrite values in mujoco datas. For example here we overwrite the position values of the joints:</p>
<ul class="simple">
<li><p>https://github.com/intelligent-soft-robots/pam_mujoco/blob/master/include/pam_mujoco/mirror_robot.hxx#L84</p></li>
</ul>
</section>
<section id="relation-between-o80-and-controllers">
<h2>Relation between o80 and controllers<a class="headerlink" href="#relation-between-o80-and-controllers" title="Permalink to this headline"></a></h2>
<p>The above explains how we can overwrite mujoco values with values of our choice. Here we will see how we get the values “of our choice”.
MirrorRobot encapsulates an instance of o80 backend:</p>
<ul class="simple">
<li><p>https://github.com/intelligent-soft-robots/pam_mujoco/blob/master/include/pam_mujoco/mirror_robot.hxx#L8</p></li>
</ul>
<p>This backend’s job is to provide desired values for each iteration, via its “pulse” function:</p>
<ul class="simple">
<li><p>https://github.com/intelligent-soft-robots/pam_mujoco/blob/master/include/pam_mujoco/mirror_robot.hxx#L61</p></li>
</ul>
<p>The pipeline during runtime is:</p>
<p>A o80 frontend is used by the user to set desired values via commands (add_command and pulse functions), as for example here:</p>
<ul class="simple">
<li><p>https://github.com/intelligent-soft-robots/pam_demos/blob/main/tutorial_4_frontend.py#L33</p></li>
</ul>
<p>which results in desired values here (same link as above):</p>
<ul class="simple">
<li><p>https://github.com/intelligent-soft-robots/pam_mujoco/blob/master/include/pam_mujoco/mirror_robot.hxx#L61</p></li>
</ul>
</section>
<section id="putting-things-together">
<h2>Putting things together<a class="headerlink" href="#putting-things-together" title="Permalink to this headline"></a></h2>
<p>Hopefully the above will clarify what happens in this file:</p>
<ul class="simple">
<li><p>https://github.com/intelligent-soft-robots/pam_demos/blob/main/tutorials/tutorial_4.py</p></li>
</ul>
<p>Here:</p>
<ul class="simple">
<li><p>https://github.com/intelligent-soft-robots/pam_demos/blob/main/tutorials/tutorial_4.py#27</p></li>
</ul>
<p>the xml file is generated and the controllers are added.</p>
</section>
<section id="c-and-python">
<h2>C++ and Python<a class="headerlink" href="#c-and-python" title="Permalink to this headline"></a></h2>
<p>In the above, some code is in C++, so other code is in Python.
It works because Python encapsulate the C++ code, here:</p>
<ul class="simple">
<li><p>https://github.com/intelligent-soft-robots/pam_mujoco/blob/master/srcpy/wrappers.cpp</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="E3_packages_overview.html" class="btn btn-neutral float-left" title="Developer’s guide 3: Packages overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="E5_documentation.html" class="btn btn-neutral float-right" title="Developer’s guide: Updating the documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Empirical Inference, Max Planck Institute for Intelligent Systems.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>